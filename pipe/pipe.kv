#:kivy 1.10.1
#:import Factory kivy.factory.Factory


<InputArgumentSetWidget>:
    size_hint: 0.1, 1

<OutputArgumentSetWidget>:
    size_hint: 0.1, 1

<NodeWidget>:
    size_hint: 0.2, 0.1
    input_widgets: input_widgets
    output_widgets: output_widgets

    canvas:
        Color: 
            hsv: .56, .53, .7
            a: 1
        Rectangle:
            size: root.size
            pos: root.pos

    InputArgumentSetWidget:
        size_hint: 0.1, 1
        id: input_widgets
        orientation: "vertical"
    
    Label:
        size_hint: 0.8, 1
        text: root.node.template.name if root.node is not None else "Untitled"
    
    OutputArgumentSetWidget:
        size_hint: 0.1, 1
        id: output_widgets
        orientation: "vertical"

<EdgeWidget>:
    size_hint: None, None
    canvas.after:
        Color: 
            rgba: [1, 1, 1, 1]
        Line:
            width: 3
            points: self.from_x, self.from_y, self.to_x, self.to_y

<NewNodePopup@Popup>:
    names: []
    size_hint: 0.5, 0.2
    title: "Create a new node"

    BoxLayout:
        orientation: "vertical"

        Spinner:
            id: options
            size_hint: 0.9, 0.9
            pos: root.pos
            text: 'Select template'
            values: root.names
        
        Button:
            text: 'Create'
            on_release: root.dismiss()

<SwitchGraphPopup@Popup>:
    names: []
    size_hint: 0.5, 0.2
    title: "Switch to a graph"

    BoxLayout:
        orientation: "vertical"

        Spinner:
            id: options
            size_hint: 0.9, 0.9
            pos: root.pos
            text: 'Select graph'
            values: root.names
        
        Button:
            text: 'Switch'
            on_release: root.dismiss()

<NewTemplatePopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Create a new template"
    on_open: self.ids.name.focus=True

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"
        
        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Collection"
            TextInput:
                id: collection
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Template Name"
            TextInput:
                id: name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Input Arguments"
            TextInput:
                id: inputs
                multiline: False
                text: ''

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Output Arguments"
            TextInput:
                id: outputs
                multiline: False
                input_type: 'number'
                text: ''
        
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Create'
                on_release: root.dismiss()

<NewGraphPopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Create a new graph"
    on_open: self.ids.name.focus=True

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Graph Name"
            TextInput:
                id: name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Create'
                on_release: root.dismiss()

<OpenProjectPopup@Popup>:
    size_hint: 0.7, 0.7
    title: 'Open Project'

    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.9
            path: '.'
            filters: ["*.json"]

        BoxLayout:
            size_hint: 1, 0.1

            Button:
                text: "Open Project"
                on_release: root.dismiss()

<SaveProjectPopup@Popup>:
    size_hint: 0.7, 0.7
    title: 'Save Project'
    
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.8
            path: '.'
            filters: ["*."]
            on_selection: root.ids.text_input.text = self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint: 1, 0.1
            multiline: False

        BoxLayout:
            size_hint_y: None
            size_hint: 1, 0.1
            Button:
                text: "Save Project"
                on_release: root.dismiss()

<ExportAssembledProgram@Popup>:
    size_hint: 0.7, 0.7
    title: 'Export assembled program'
    
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.8
            path: '.'
            filters: ["*.py"]
            on_selection: root.ids.text_input.text = self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint: 1, 0.1
            multiline: False

        BoxLayout:
            size_hint_y: None
            size_hint: 1, 0.1
            Button:
                text: "Export"
                on_release: root.dismiss()

<GraphWidget>:
    canvas.before:
        Color:
            hsv: 0, 0, .2
            a: 1
        Rectangle:
            pos: self.pos
            size: self.size

<Desktop>:
    
    BoxLayout:
        size_hint: 1, 1
        orientation: "vertical"

        BoxLayout:
            size_hint: 1,0.95
            orientation: 'horizontal'

            BoxLayout:
                background_color: (1, 1, 1, 1)
                size_hint: 0.7, 1
                orientation: 'vertical'
                pos: self.parent.x + self.parent.width * 0.5, self.parent.y
                
                GraphWidget:
                    id: editor
                    size_hint: 1.0, 0.95
                    pos: root.pos

                GridLayout:
                    cols: 3
                    size_hint: 1, 0.05
                    id: graph_menu

            
            BoxLayout:
                size_hint: 0.3, 1
                orientation: 'vertical'

                GridLayout:
                    size_hint: 1, 0.05
                    cols: 2
                    Label:
                        id: graph_name
                        text: root.ids.editor.graph.name if root.ids.editor.graph else "uninitialized"
                        canvas.before:
                            Color: 
                                hsv: 0.0, .56, 1.0
                                a: 1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                GridLayout:
                    size_hint: 1, 0.05
                    cols: 2
                    Label:
                        text: root.ids.editor.selected_node_widget.node.template.name if root.ids.editor.selected_node_widget else "nothing selected"
                        canvas.before:
                            Color: 
                                hsv: 0.0, .56, 1.0
                                a: 1
                            Rectangle:
                                pos: self.pos
                                size: self.size
                        

                Label:
                    size_hint: 1, 0.025
                    text: "Documentation"
                    canvas.before:
                        Color: 
                            hsv: 0.0, .56, 1.0
                            a: 1
                        Rectangle:
                            pos: self.pos
                            size: self.size

                TextInput:
                    size_hint: 1, 0.2
                    id: documentation_panel
                    text: root.ids.editor.selected_node_widget.node.template.documentation if root.ids.editor.selected_node_widget else "nothing selected"
                    on_text: if root.ids.editor.selected_node_widget: root.ids.editor.selected_node_widget.node.template.documentation = self.text

                Label:
                    size_hint: 1, 0.025
                    text: "Implementation"
                    canvas.before:
                        Color: 
                            hsv: 0.0, .56, 1.0
                            a: 1
                        Rectangle:
                            pos: self.pos
                            size: self.size

                CodeInput:
                    id: code_panel
                    size_hint: 1, 0.45
                    text: root.ids.editor.selected_node_widget.node.template.code if root.ids.editor.selected_node_widget else "nothing selected"
                    on_text: if root.ids.editor.selected_node_widget: root.ids.editor.selected_node_widget.node.template.code = self.text

                GridLayout:
                    cols: 3
                    size_hint: 1, 0.3

                    Button:
                        text: 'Open'
                        on_release: root.open_project()
                    Button:
                        text: 'Save'
                        on_release: root.save_project()
                    Button:
                        text: '  '
                        on_release: pass

                    Button:
                        text: 'New Template'
                        on_release: root.start_new_template_prompt()
                    Button:
                        text: 'New Graph'
                        on_release: root.start_new_graph_prompt()
                    Button:
                        text: 'Switch Graph'
                        on_release: root.start_switch_graph_prompt()

                    
                    Button:
                        text: 'Delete Node'
                        on_release: root.ids.editor.delete_selected()
                    Button:
                        text: '  '
                        on_release: pass
                    Button:
                        text: '  '
                        on_release: pass
                    
                    Button:
                        text: 'Assemble'
                        on_release: root.assemble_and_save()
                    Button:
                        text: 'Execute'
                        on_release: root.assemble_and_execute()
                    Button:
                        text: '  '
                        on_release: pass
                        

        Label:
            id: status_bar
            size_hint: 1, 0.05
            text: "    Status Bar"
            halign: 'left'
            valign: 'center'
            text_size: self.size

            canvas.before:
                Color: 
                    hsv: .56, .53, .7
                    a: 1
                Rectangle:
                    pos: self.pos
                    size: self.size
                    

