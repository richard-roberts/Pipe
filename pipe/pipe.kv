#:kivy 1.10.1
#:import Factory kivy.factory.Factory
#:import Globals globals

<ArgumentWidget>:

    canvas:
        Color:
            rgba: self.background_color
        Rectangle:
            pos: self.pos
            size: self.size[0], self.size[1] * 0.1

<InputArgumentWidget>:
    widgets: None

<OutputArgumentWidget>:
    widgets: None

<InputArgumentSetWidget>:
    size_hint: 0.1, 1

<OutputArgumentSetWidget>:
    size_hint: 0.1, 1

<NodeWidget>:
    size_hint: 0.2, 0.1
    input_widgets: input_widgets
    output_widgets: output_widgets

    canvas:
        Color:
            rgb: self.background_color.r, self.background_color.g, self.background_color.b
            a: self.background_color.a
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: "horizontal"
        size_hint: 1, 1

        InputArgumentSetWidget:
            size_hint: 0.1, 1
            id: input_widgets
            orientation: "vertical"

        BoxLayout:
            orientation: "vertical"
            size_hint: 0.8, 1

            Label:
                size_hint: 1, 0.5
                text: root.node.alias if root.node is not None else "Untitled"

            GridLayout:
                orientation: "horizontal"
                size_hint: 1, 0.5
                cols: 2

                Button:
                    text: "x"
                    on_release: Globals.GraphWidget().instance.delete_node_and_connected_edges_by_widget(self.parent.parent.parent.parent)

                Button:
                    text: "e"
                    on_release: Globals.GraphWidget().instance.edit_node(self.parent.parent.parent.parent)

                Button:
                    text: "i=-1"
                    id: execution_index_button
                    on_release: root.start_set_execution_index_prompt()

                Button:
                    text: "EX"
                    on_release: root.evaluate_upward()

        OutputArgumentSetWidget:
            size_hint: 0.1, 1
            id: output_widgets
            orientation: "vertical"

<EdgeWidget>:
    from_x: self.widget_from.x + self.widget_from.width
    from_y: self.widget_from.y + self.widget_from.height / (1 + len(self.widget_from.argument.get_node().outputs))
    to_x: self.widget_to.x
    to_y: self.widget_to.y + self.widget_to.height / (1 + len(self.widget_to.argument.get_node().inputs))

    canvas:
        Color:
            rgb: self.edge_color.r, self.edge_color.g, self.edge_color.b
            a: self.edge_color.a
        Line:
            width: 2
            points: self.from_x, self.from_y, self.to_x, self.to_y


<SetDefaultValuePopup@Popup>:
    size_hint: 0.8, 0.5
    reset_to_none: False

    BoxLayout:
        orientation: "vertical"
        size_hint: 0.9, 0.9

        GridLayout:
            size_hint: 1, 0.8
            cols: 2

            Label:
                text: "Boolean"
            TextInput:
                id: bool_value
                multiline: False
            Label:
                text: "Number"
            TextInput:
                id: num_value
                multiline: False
            Label:
                text: "String"
            TextInput:
                id: str_value
                multiline: False

        Button:
            size_hint: 1, 0.1
            text: "Reset"
            on_release: root.reset_to_none = True; root.dismiss()

        Button:
            size_hint: 1, 0.1
            text: "Set"
            on_release: root.dismiss()


<SetExecutionIndexPopup@Popup>:
    size_hint: 0.8, 0.5
    used: False

    on_open: root.ids.new_index.focus = True

    BoxLayout:
        orientation: "vertical"
        size_hint: 0.9, 0.9

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.9

            Label:
                text: "New Index"
            TextInput:
                id: new_index
                multiline: False
                on_text_validate: root.used = True; root.dismiss()

        Button:
            text: "Set"
            size_hint: 1, 0.1
            on_release: root.used = True; root.dismiss()


<NewNodePopup@Popup>:
    names: []
    size_hint: 0.9, 0.9
    used: False
    most_similar: ""
    new_template_callback: None
    title: "Create a new node"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "vertical"
            size_hint: 1, 0.3

            BoxLayout:
                orientation: "horizontal"
                size_hint: 1, 0.2

                Label:
                    text: "Search"
                    size_hint: 0.3, 1
                TextInput:
                    size_hint: 0.7, 1
                    id: search_bar
                    multiline: False

            BoxLayout:
                orientation: "vertical"
                size_hint: 1, 0.8
                id: search_results

        BoxLayout:
            size_hint: 1, 0.65
            id: options_menu

        Button:
            size_hint: 1, 0.05
            text: "From new template"
            on_release: root.new_template_callback()

<NewTemplatePopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Create a new template"
    on_open: self.ids.name.focus=True

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"
        
        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Collection"
            TextInput:
                id: collection
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Template Name"
            TextInput:
                id: name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Input Arguments"
            TextInput:
                id: inputs
                multiline: False
                text: ''

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Output Arguments"
            TextInput:
                id: outputs
                multiline: False
                input_type: 'number'
                text: ''
        
        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Create'
                on_release: root.dismiss()

<EditTemplatePopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Edit template"

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Collection"
            TextInput:
                id: collection
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Template Name"
            TextInput:
                id: name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Input Arguments"
            TextInput:
                id: inputs
                multiline: False
                text: ''

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Output Arguments"
            TextInput:
                id: outputs
                multiline: False
                input_type: 'number'
                text: ''

        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Create'
                on_release: root.dismiss()

<EditNodePopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Edit node"

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"

        TextInput:
            size_hint: 1, 0.1
            id: alias_edit
            multiline: False

        Label:
            text: "Input Arguments"
            size_hint: 1, 0.05

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.4

            BoxLayout:
                orientation: "vertical"
                size_hint: 0.25, 1
                id: input_names
                Label:
                    text: "Name"
            BoxLayout:
                orientation: "vertical"
                size_hint: 0.25, 1
                id: input_aliases
                Label:
                    text: "Alias"
            BoxLayout:
                orientation: "vertical"
                size_hint: 0.25, 1
                id: input_defaults
                Label:
                    text: "Default"
            BoxLayout:
                orientation: "vertical"
                size_hint: 0.25, 1
                id: input_values
                Label:
                    text: "Eval"

        Label:
            text: "Output Arguments"
            size_hint: 1, 0.05

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.4

            BoxLayout:
                orientation: "vertical"
                size_hint: 0.33, 1
                id: output_names
                Label:
                    text: "Name"
            BoxLayout:
                orientation: "vertical"
                size_hint: 0.33, 1
                id: output_aliases
                Label:
                    text: "Alias"
            BoxLayout:
                orientation: "vertical"
                size_hint: 0.25, 1
                id: output_values
                Label:
                    text: "Eval"


<NewGraphPopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Create a new graph"
    on_open: self.ids.name.focus=True

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Graph Name"
            TextInput:
                id: name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Create'
                on_release: root.dismiss()

<RenameGraphPopup@Popup>:
    size_hint: 0.8, 0.5
    title: "Rename a graph"
    on_open: self.ids.new_name.focus=True
    used: False

    BoxLayout:
        size_hint: 0.9, 0.9
        pos: root.pos
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "Old Name"
            TextInput:
                id: old_name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Label:
                text: "New Name"
            TextInput:
                id: new_name
                multiline: False

        BoxLayout:
            orientation: "horizontal"
            Button:
                text: 'Rename'
                on_release: root.used=True; root.dismiss()

<OpenProjectPopup@Popup>:
    size_hint: 0.7, 0.7
    title: 'Open Project'
    used: False

    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.9
            path: '.'
            filters: ["*.json"]

        BoxLayout:
            size_hint: 1, 0.1
            orientation: "horizontal"

            Button:
                text: "Open Project"
                on_release: root.used = True; root.dismiss()


<SaveProjectPopup@Popup>:
    size_hint: 0.7, 0.7
    title: 'Save Project'
    
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.8
            path: '.'
            filters: ["*."]
            on_selection: root.ids.text_input.text = self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint: 1, 0.1
            multiline: False

        BoxLayout:
            size_hint_y: None
            size_hint: 1, 0.1
            Button:
                text: "Save Project"
                on_release: root.dismiss()

<ExportAssembledProgram@Popup>:
    size_hint: 0.7, 0.7
    title: 'Export assembled program'
    
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"

        FileChooserIconView:
            id: filechooser
            size_hint: 1, 0.8
            path: '.'
            filters: ["*.py"]
            on_selection: root.ids.text_input.text = self.selection[0] or ''

        TextInput:
            id: text_input
            size_hint: 1, 0.1
            multiline: False

        BoxLayout:
            size_hint_y: None
            size_hint: 1, 0.1
            Button:
                text: "Export"
                on_release: root.dismiss()

<GraphWidget>:
    canvas.before:
        Color:
            hsv: 0, 0, .2
            a: 1
        Rectangle:
            pos: self.pos
            size: self.size

<Desktop>:
    
    BoxLayout:
        size_hint: 1, 1
        orientation: "vertical"

        BoxLayout:
            size_hint: 1,0.95
            orientation: 'horizontal'

            BoxLayout:
                background_color: (1, 1, 1, 1)
                size_hint: 0.7, 1
                orientation: 'vertical'
                pos: self.parent.x + self.parent.width * 0.5, self.parent.y

                GraphWidget:
                    id: editor
                    size_hint: 1.0, 0.95
                    pos: root.pos

                BoxLayout:
                    size_hint: 1.0, 0.05
                    orientation: "horizontal"

                    Button:
                        size_hint: 0.05, 1
                        text: 'r'
                        on_release: root.start_rename_graph_prompt()

                    Button:
                        size_hint: 0.05, 1
                        text: '-'
                        on_release: root.delete_current_graph()

                    Button:
                        size_hint: 0.05, 1
                        text: '+'
                        on_release: root.start_new_graph_prompt()

                    BoxLayout:
                        size_hint: 0.9, 1
                        orientation: "horizontal"
                        id: graph_selection_menu


            Splitter:
                sizable_from: 'left'
                size_hint: 0.3, 1

                BoxLayout:
                    size_hint: 1, 1
                    orientation: 'vertical'

                    GridLayout:
                        size_hint: 1, 0.05
                        cols: 2
                        Label:
                            text: root.ids.editor.selected_node_widget.node.template.name if root.ids.editor.selected_node_widget else "nothing selected"
                            canvas.before:
                                Color:
                                    hsv: 0.0, .56, 1.0
                                    a: 1
                                Rectangle:
                                    pos: self.pos
                                    size: self.size


                    Label:
                        size_hint: 1, 0.025
                        text: "Documentation"
                        canvas.before:
                            Color:
                                hsv: 0.0, .56, 1.0
                                a: 1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    TextInput:
                        size_hint: 1, 0.2
                        id: documentation_panel
                        text: root.ids.editor.selected_node_widget.node.template.documentation if root.ids.editor.selected_node_widget else "nothing selected"
                        on_text: if root.ids.editor.selected_node_widget: root.ids.editor.selected_node_widget.node.template.documentation = self.text

                    Label:
                        size_hint: 1, 0.025
                        text: "Implementation"
                        canvas.before:
                            Color:
                                hsv: 0.0, .56, 1.0
                                a: 1
                            Rectangle:
                                pos: self.pos
                                size: self.size

                    BoxLayout:
                        size_hint: 1, 0.65
                        orientation: "vertical"

                        CodeInput:
                            id: code_panel
                            size_hint: 1, 0.95
                            text: root.ids.editor.selected_node_widget.node.template.code if root.ids.editor.selected_node_widget else "nothing selected"
                            on_text: if root.ids.editor.selected_node_widget: root.ids.editor.selected_node_widget.node.template.code = self.text

                        Button:
                            size_hint: 1, 0.05
                            text: "Open in Editor"
                            on_release: root.open_node_code_externally()

                    GridLayout:
                        cols: 2
                        size_hint: 1, 0.1

                        Button:
                            text: 'Reset'
                            on_release: root.reset_project()
                        Button:
                            text: 'Save'
                            on_release: root.save_project()
                        Button:
                            text: 'Assemble'
                            on_release: root.assemble_and_save()
                        Button:
                            text: 'Execute'
                            on_release: root.assemble_and_execute()

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1, 0.05

            Label:
                id: status_bar
                size_hint: 0.8, 1.0
                text: "    Status Bar"
                halign: 'left'
                valign: 'center'
                text_size: self.size

                canvas.before:
                    Color:
                        hsv: .56, .53, .7
                        a: 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

            TextInput:
                size_hint: 0.2, 1.0
                id: command_line_args
                text: ""
